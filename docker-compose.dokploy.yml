services:
  db:
    extends:
      file: docker-compose.yml
      service: db
    volumes:
      - mongo_data:/data/db

  otel-collector:
    image: ${HDX_IMAGE_REPO}/${OTEL_COLLECTOR_IMAGE_NAME_DOCKERHUB}:${IMAGE_VERSION}
    environment:
      CLICKHOUSE_ENDPOINT: "tcp://ch-server:9000?dial_timeout=10s"
      HYPERDX_OTEL_EXPORTER_CLICKHOUSE_DATABASE: ${HYPERDX_OTEL_EXPORTER_CLICKHOUSE_DATABASE}
      HYPERDX_LOG_LEVEL: ${HYPERDX_LOG_LEVEL}
      OPAMP_SERVER_URL: "http://app:${HYPERDX_OPAMP_PORT}"
    ports:
      - "4318:4318" # OTLP HTTP para Next.js
      # - "4317:4317" # Si necesitas OTLP gRPC, descomentar
    restart: always
    networks:
      - internal
    depends_on:
      - ch-server

  app:
    extends:
      file: docker-compose.yml
      service: app
    # Quitamos los puertos expuestos (Traefik los manejar√°)
    ports: []
    environment:
      FRONTEND_URL: ${HYPERDX_APP_URL}

  ch-server:
    extends:
      file: docker-compose.yml
      service: ch-server
    volumes:
      - ch_data:/var/lib/clickhouse
      - ch_logs:/var/log/clickhouse-server
networks:
  internal:

volumes:
  mongo_data:
  ch_data:
  ch_logs: